TGTDEV = "/dev/vda"

sed -e 's/\s*\([\+0-9a-zA-Z]*\).*/\1/' << EOF | fdisk ${TGTDEV}
  o # clear the in memory partition table
  n # new partition
  p # primary partition
  1 # partition number 1
    # default - start at beginning of disk 
  +500M # 100 MB boot parttion
  n # new partition
  p # primary partition
  2 # partion number 2
    # default, start immediately after preceding partition
    # default, extend partition to end of disk
  w # write the partition table
  q # and we're done
EOF

mkfs.fat -F 32 ${TGTDEV}1
fatlabel ${TGTDEV}1 NIXBOOT
mkfs.ext4 ${TGTDEV}2 -L NIXROOT
mount /dev/disk/by-label/NIXROOT /mnt
mkdir -p /mnt/boot
mount /dev/disk/by-label/NIXBOOT /mnt/boot

# Swap -- can be disabled
dd if=/dev/zero of=/mnt/.swapfile bs=1024 count=2097152 # 2GB ONLY
chmod 600 /mnt/.swapfile
mkswap /mnt/.swapfile
swapon /mnt/.swapfile


nixos-generate-config --root /mnt
cp /mnt/etc/nixos/hardware-configuration.nix ../nixos
nixos-rebuild switch --install --flake


